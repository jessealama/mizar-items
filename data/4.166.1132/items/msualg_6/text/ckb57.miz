environ
vocabularies NUMBERS,XBOOLE_0,MSUALG_1,SUBSET_1,FUNCT_1,PBOOLE,MEMBER_1,RELAT_1,STRUCT_0,CARD_3,MARGREL1,PARTFUN1,MOD_4,MSUALG_3,NAT_1,FUNCT_4,RLTOPSP1,TARSKI,REWRITE1,FUNCOP_1,FINSEQ_1,ARYTM_3,FUNCT_7,CARD_1,XXREAL_0,ORDINAL4,MSUALG_4,CIRCUIT2,MCART_1,ZFMISC_1,EQREL_1,RELAT_2,MSUALG_5,MSUALG_6;
notations TARSKI,XBOOLE_0,ZFMISC_1,SUBSET_1,NUMBERS,NAT_1,MCART_1,STRUCT_0,RELAT_1,RELAT_2,RELSET_1,EQREL_1,REWRITE1,FUNCT_1,PBOOLE,PARTFUN1,FUNCT_2,FINSEQ_1,CARD_3,FUNCOP_1,MSUALG_1,MSUALG_3,MSUALG_4,MSUALG_5,FUNCT_7,XXREAL_0,CKB1,CKB2,CKB5,CKB9,CKB13,CKB14,CKB18,CKB20,CKB25,CKB39,CKB40,CKB41,CKB49,CKB53,CKB56;
definitions TARSKI,RELAT_1,REWRITE1,FUNCT_1,PBOOLE,MSUALG_3,MSUALG_4,FUNCT_7,FUNCOP_1,CKB5,CKB9,CKB14,CKB18,CKB20,CKB25,CKB39,CKB40,CKB41,CKB49,CKB53,CKB56;
theorems TARSKI,NAT_1,MCART_1,ZFMISC_1,RELAT_1,RELSET_1,EQREL_1,FUNCT_1,FINSEQ_1,FINSEQ_3,FUNCT_2,CARD_3,FUNCT_7,REWRITE1,PBOOLE,PRALG_2,MSUALG_3,MSUALG_4,MSUALG_5,FINSEQ_5,XBOOLE_0,PARTFUN1,RELAT_2,ORDERS_1,XREAL_1,XXREAL_0,ORDINAL1,CKB3,CKB4,CKB5,CKB6,CKB9,CKB10,CKB11,CKB12,CKB14,CKB15,CKB16,CKB17,CKB18,CKB19,CKB20,CKB21,CKB22,CKB23,CKB24,CKB25,CKB26,CKB27,CKB28,CKB29,CKB30,CKB31,CKB33,CKB34,CKB35,CKB36,CKB37,CKB38,CKB39,CKB40,CKB41,CKB42,CKB43,CKB49,CKB53,CKB54,CKB55,CKB56;
schemes NAT_1,RECDEF_1,RELSET_1,FUNCT_1,FINSEQ_1,CARD_3,CLASSES1,PBOOLE,PUA2MSS1,CKB32,CKB47,CKB48,CKB52;
registrations XBOOLE_0,RELAT_1,FUNCT_1,PARTFUN1,FUNCT_2,FUNCOP_1,XXREAL_0,XREAL_0,NAT_1,FINSEQ_1,PBOOLE,REWRITE1,FUNCT_7,STRUCT_0,MSUALG_1,MSUALG_3,MSUALG_4,MSUALG_5,ORDINAL1,CARD_1,RELSET_1,CKB7,CKB8,CKB44,CKB45,CKB46,CKB50,CKB51;
constructors XXREAL_0,NAT_1,NAT_D,REWRITE1,FUNCT_7,MSUALG_3,MSUALG_5,RELSET_1,CKB2,CKB5,CKB9,CKB13,CKB14,CKB18,CKB20,CKB25,CKB39,CKB40,CKB41,CKB49,CKB53,CKB56;
requirements NUMERALS,REAL,BOOLE,SUBSET,ARITHM;
begin
reserve S for non  empty non  void ManySortedSign;
reserve A for  non-empty MSAlgebra over S;
Lm2:now
let S being non  empty non  void ManySortedSign;
let A being  non-empty MSAlgebra over S;
let R being (ManySortedRelation of A);
let Q being (ManySortedRelation of A);
defpred R[ (ManySortedRelation of A) ]
 means
$1 is  stable;
defpred P[ Function,(SortSymbol of S),(SortSymbol of S) ]
 means
($2 = $3 & (ex h being (Endomorphism of A) st $1 = ( h . $2 )));
A1: (for s1,s2,s3 being (SortSymbol of S) holds (for f1 being (Function of ( (the Sorts of A) . s1 ),( (the Sorts of A) . s2 )) holds (for f2 being (Function of ( (the Sorts of A) . s2 ),( (the Sorts of A) . s3 )) holds ((P[ f1,s1,s2 ] & P[ f2,s2,s3 ]) implies P[ ( f2 * f1 ),s1,s3 ]))))
proof
let s1 being (SortSymbol of S);
let s2 being (SortSymbol of S);
let s3 being (SortSymbol of S);
let f1 being (Function of ( (the Sorts of A) . s1 ),( (the Sorts of A) . s2 ));
let f2 being (Function of ( (the Sorts of A) . s2 ),( (the Sorts of A) . s3 ));
assume A2: s1 = s2;
given h1 being (Endomorphism of A) such that
A3: f1 = ( h1 . s1 );

assume A4: s2 = s3;
given h2 being (Endomorphism of A) such that
A5: f2 = ( h2 . s2 );

thus s1 = s3 by A2,A4;
reconsider h = ( h2 ** h1 ) as (Endomorphism of A);
take h;
thus thesis by A2,A3,A5,MSUALG_3:2;
end;
A6: (for R being (ManySortedRelation of A) holds (R[ R ] iff (for s1,s2 being (SortSymbol of S) holds (for f being (Function of ( (the Sorts of A) . s1 ),( (the Sorts of A) . s2 )) holds (P[ f,s1,s2 ] implies (for a,b being set holds ([ a,b ] in ( R . s1 ) implies [ ( f . a ),( f . b ) ] in ( R . s2 ))))))))
proof
let R being (ManySortedRelation of A);
thus (R is  stable implies (for s1,s2 being (SortSymbol of S) holds (for f being (Function of ( (the Sorts of A) . s1 ),( (the Sorts of A) . s2 )) holds ((s1 = s2 & (ex h being (Endomorphism of A) st f = ( h . s1 ))) implies (for a,b being set holds ([ a,b ] in ( R . s1 ) implies [ ( f . a ),( f . b ) ] in ( R . s2 ))))))) by CKB41:def 1;
assume A7: (for s1,s2 being (SortSymbol of S) holds (for f being (Function of ( (the Sorts of A) . s1 ),( (the Sorts of A) . s2 )) holds (P[ f,s1,s2 ] implies (for a,b being set holds ([ a,b ] in ( R . s1 ) implies [ ( f . a ),( f . b ) ] in ( R . s2 ))))));
thus R is  stable
proof
let h being (Endomorphism of A);
let s being (SortSymbol of S);
thus thesis by A7;
end;

end;
A8: (for s being (SortSymbol of S) holds P[ ( id ( (the Sorts of A) . s ) ),s,s ])
proof
reconsider h = ( id (the Sorts of A) ) as (Endomorphism of A) by CKB10:1;
let s being (SortSymbol of S);
thus s = s;
take h;
thus thesis by MSUALG_3:def 1;
end;
assume that
A9: (for s being (SortSymbol of S) holds (for a,b being (Element of A,s) holds ([ a,b ] in ( Q . s ) iff (ex s9 being (SortSymbol of S) st (ex f being (Function of ( (the Sorts of A) . s9 ),( (the Sorts of A) . s )) st (ex x,y being (Element of A,s9) st (((P[ f,s9,s ] & [ x,y ] in ( R . s9 )) & a = ( f . x )) & b = ( f . y ))))))));
thus ((R[ Q ] & R c= Q) & (for P being (ManySortedRelation of A) holds ((R[ P ] & R c= P) implies Q c= P))) from CKB52:sch 1(A6,A1,A8,A9);
end;
theorem
Th31: (for R being (ManySortedRelation of (the Sorts of A)) holds (for s being (SortSymbol of S) holds (for a,b being (Element of A,s) holds ([ a,b ] in ( ( StabCl R ) . s ) iff (ex x,y being (Element of A,s) st (ex h being (Endomorphism of A) st (([ x,y ] in ( R . s ) & a = ( ( h . s ) . x )) & b = ( ( h . s ) . y ))))))))
proof
let P being (ManySortedRelation of (the Sorts of A));
defpred Z[ (SortSymbol of S),set,set ]
 means
(ex s9 being (SortSymbol of S) st (ex f being (Function of ( (the Sorts of A) . s9 ),( (the Sorts of A) . $1 )) st (ex x,y being (Element of A,s9) st ((((s9 = $1 & (ex h being (Endomorphism of A) st f = ( h . s9 ))) & [ x,y ] in ( P . s9 )) & $2 = ( f . x )) & $3 = ( f . y )))));
let s being (SortSymbol of S);
let a being (Element of A,s);
let b being (Element of A,s);
consider Q being (ManySortedRelation of (the Sorts of A)) such that A1: (for s being (SortSymbol of S) holds (for a,b being (Element of A,s) holds ([ a,b ] in ( Q . s ) iff Z[ s,a,b ]))) from CKB47:sch 1;
reconsider R = P,Q as (ManySortedRelation of A);
A2: R c= Q by A1,Lm2;
reconsider Q as  stable (ManySortedRelation of A) by A1,Lm2;
R c= ( StabCl R ) by CKB56:def 1;
then A3: Q c= ( StabCl R ) by A1,Lm2;
( StabCl R ) c= Q by A2,CKB56:def 1;
then A4: ( StabCl R ) = Q by A3,PBOOLE:def 10;
hereby
assume [ a,b ] in ( ( StabCl P ) . s );
then (ex s9 being (SortSymbol of S) st (ex f being (Function of ( (the Sorts of A) . s9 ),( (the Sorts of A) . s )) st (ex x,y being (Element of A,s9) st ((((s9 = s & (ex h being (Endomorphism of A) st f = ( h . s9 ))) & [ x,y ] in ( P . s9 )) & a = ( f . x )) & b = ( f . y ))))) by A1,A4;
hence (ex x,y being (Element of A,s) st (ex h being (Endomorphism of A) st (([ x,y ] in ( P . s ) & a = ( ( h . s ) . x )) & b = ( ( h . s ) . y ))));
end;
thus thesis by A1,A4;
end;
