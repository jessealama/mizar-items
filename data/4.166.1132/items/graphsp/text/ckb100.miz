environ
vocabularies NUMBERS,SUBSET_1,FINSEQ_1,INT_1,RELAT_1,FUNCT_1,ORDINAL4,XBOOLE_0,XXREAL_0,PARTFUN1,GRAPH_1,STRUCT_0,TREES_2,GLIB_000,GRAPH_5,CARD_3,GRAPH_4,NAT_1,ARYTM_3,TARSKI,CARD_1,FINSET_1,FUNCT_4,REAL_1,FUNCT_2,ARYTM_1,GRAPHSP;
notations XCMPLX_0,XXREAL_0,REAL_1,INT_1,TARSKI,XBOOLE_0,SUBSET_1,RELAT_1,FUNCT_1,FINSEQ_1,SEQ_1,FINSEQ_2,FINSEQ_4,CARD_1,FINSET_1,STRUCT_0,GRAPH_1,PARTFUN1,FUNCT_2,CQC_SIM1,GRAPH_4,GRAPH_5,NAT_D,DOMAIN_1,RVSUM_1,NUMBERS,FUNCT_7,NAT_1,CKB21,CKB22,CKB23,CKB28,CKB29,CKB30,CKB34,CKB35,CKB36,CKB37,CKB38,CKB39,CKB40,CKB44,CKB45,CKB51,CKB54,CKB62,CKB63,CKB64,CKB65,CKB75,CKB83,CKB84,CKB86,CKB93,CKB94;
definitions TARSKI,RVSUM_1,CKB23,CKB30,CKB35,CKB36,CKB37,CKB38,CKB39,CKB44,CKB45,CKB51,CKB54,CKB62,CKB63,CKB64,CKB65,CKB75,CKB83,CKB84,CKB86,CKB93,CKB94;
theorems FUNCT_2,FUNCT_1,PARTFUN1,FINSEQ_1,NAT_1,ZFMISC_1,TARSKI,FINSEQ_3,XBOOLE_0,XBOOLE_1,SUBSET_1,GRAPH_1,FINSEQ_4,CARD_2,INT_1,GRAPH_5,GRAPH_4,FINSEQ_2,ENUMSET1,FUNCT_7,XREAL_1,XXREAL_0,FINSOP_1,ORDINAL1,NAT_D,CKB1,CKB2,CKB3,CKB4,CKB5,CKB6,CKB7,CKB8,CKB9,CKB10,CKB11,CKB12,CKB13,CKB14,CKB15,CKB16,CKB17,CKB18,CKB19,CKB20,CKB23,CKB24,CKB25,CKB26,CKB27,CKB30,CKB31,CKB32,CKB33,CKB35,CKB36,CKB37,CKB38,CKB39,CKB41,CKB42,CKB43,CKB44,CKB45,CKB46,CKB48,CKB49,CKB51,CKB52,CKB53,CKB54,CKB55,CKB56,CKB57,CKB58,CKB59,CKB60,CKB61,CKB62,CKB63,CKB64,CKB65,CKB66,CKB67,CKB68,CKB69,CKB70,CKB71,CKB72,CKB73,CKB74,CKB75,CKB76,CKB77,CKB78,CKB79,CKB80,CKB81,CKB82,CKB83,CKB84,CKB85,CKB86,CKB87,CKB88,CKB89,CKB90,CKB91,CKB92,CKB93,CKB94,CKB95,CKB96,CKB97,CKB98,CKB99;
schemes NAT_1,GRAPH_5,CLASSES1;
registrations XBOOLE_0,ORDINAL1,RELSET_1,FUNCT_2,FINSET_1,NUMBERS,XXREAL_0,XREAL_0,NAT_1,INT_1,MEMBERED,FINSEQ_1,GRAPH_1,GRAPH_4,GRAPH_5,VALUED_0,CARD_1,FUNCT_1,CKB47,CKB50;
constructors DOMAIN_1,XXREAL_0,REAL_1,FINSEQ_4,FINSOP_1,NAT_D,FUNCT_7,CQC_SIM1,GRAPH_4,GRAPH_5,SEQ_1,BINOP_2,RVSUM_1,RELSET_1,CKB22,CKB23,CKB28,CKB29,CKB30,CKB34,CKB35,CKB36,CKB37,CKB38,CKB39,CKB40,CKB44,CKB45,CKB51,CKB54,CKB62,CKB63,CKB64,CKB65,CKB75,CKB83,CKB84,CKB86,CKB93,CKB94;
requirements NUMERALS,SUBSET,BOOLE,REAL,ARITHM;
begin
reserve i for (Element of ( NAT ));
reserve j for (Element of ( NAT ));
reserve k for (Element of ( NAT ));
reserve m for (Element of ( NAT ));
reserve n for (Element of ( NAT ));
reserve f for (Element of ( ( REAL ) * ));
reserve g for (Element of ( ( REAL ) * ));
reserve h for (Element of ( ( REAL ) * ));
reserve p for (FinSequence of ( NAT ));
reserve q for (FinSequence of ( NAT ));
reserve G for  finite  oriented Graph;
reserve P for  oriented (Chain of G);
reserve Q for  oriented (Chain of G);
reserve R for  oriented (Chain of G);
reserve W for (Function of (the carrier' of G),( Real>=0 ));
reserve v1 for (Vertex of G);
reserve v2 for (Vertex of G);
reserve v3 for (Vertex of G);
reserve v4 for (Vertex of G);
theorem
Lm20: ((((((((((f is_Input_of_Dijkstra_Alg G,n,W & v1 = 1) & n >= 1) & g = ( ( ( repeat ( ( Relax n ) * ( findmin n ) ) ) . k ) . f )) & h = ( ( ( repeat ( ( Relax n ) * ( findmin n ) ) ) . ( k + 1 ) ) . f )) & ( OuterVx (g,n) ) <> ( {} )) & 1 in ( UsedVx (g,n) )) & (for v3 holds (for j holds (((v3 <> v1 & v3 = j) & ( g . ( n + j ) ) <> ( - 1 )) implies (ex p st (ex P st (((((p is_simple_vertex_seq_at g,j,n & (for i holds ((1 <= i & i < ( len p )) implies ( p . i ) in ( UsedVx (g,n) )))) & P is_oriented_edge_seq_of p) & P is_shortestpath_of v1,v3,( UsedVx (g,n) ),W) & ( cost (P,W) ) = ( g . ( ( 2 * n ) + j ) )) & ((not v3 in ( UsedVx (g,n) )) implies P islongestInShortestpath ( UsedVx (g,n) ),v1,W)))))))) & (for m holds (for j holds ((((( g . ( n + j ) ) = ( - 1 ) & 1 <= j) & j <= n) & m in ( UsedVx (g,n) )) implies ( f . ( ( ( 2 * n ) + ( n * m ) ) + j ) ) = ( - 1 ))))) & (for m holds (m in ( UsedVx (g,n) ) implies ( g . ( n + m ) ) <> ( - 1 )))) implies (((for v3 holds (for j holds (((v3 <> v1 & v3 = j) & ( h . ( n + j ) ) <> ( - 1 )) implies (ex p st (ex P st (((((p is_simple_vertex_seq_at h,j,n & (for i holds ((1 <= i & i < ( len p )) implies ( p . i ) in ( UsedVx (h,n) )))) & P is_oriented_edge_seq_of p) & P is_shortestpath_of v1,v3,( UsedVx (h,n) ),W) & ( cost (P,W) ) = ( h . ( ( 2 * n ) + j ) )) & ((not v3 in ( UsedVx (h,n) )) implies P islongestInShortestpath ( UsedVx (h,n) ),v1,W))))))) & (for m holds (for j holds ((((( h . ( n + j ) ) = ( - 1 ) & 1 <= j) & j <= n) & m in ( UsedVx (h,n) )) implies ( f . ( ( ( 2 * n ) + ( n * m ) ) + j ) ) = ( - 1 ))))) & (for m holds (m in ( UsedVx (h,n) ) implies ( h . ( n + m ) ) <> ( - 1 )))))
proof
set R = ( Relax n );
set M = ( findmin n );
set IN = ( OuterVx (g,n) );
set Ug = ( UsedVx (g,n) );
assume that
A1: f is_Input_of_Dijkstra_Alg G,n,W
and
A2: v1 = 1
and
A3: n >= 1
and
A4: g = ( ( ( repeat ( R * M ) ) . k ) . f )
and
A5: h = ( ( ( repeat ( R * M ) ) . ( k + 1 ) ) . f )
and
A6: IN <> ( {} )
and
A7: 1 in Ug;
assume A8: (for v3 holds (for j holds (((v3 <> v1 & v3 = j) & ( g . ( n + j ) ) <> ( - 1 )) implies (ex p st (ex P st (((((p is_simple_vertex_seq_at g,j,n & (for i holds ((1 <= i & i < ( len p )) implies ( p . i ) in Ug))) & P is_oriented_edge_seq_of p) & P is_shortestpath_of v1,v3,Ug,W) & ( cost (P,W) ) = ( g . ( ( 2 * n ) + j ) )) & ((not v3 in Ug) implies P islongestInShortestpath Ug,v1,W)))))));
assume that
A9: (for m holds (for j holds ((((( g . ( n + j ) ) = ( - 1 ) & 1 <= j) & j <= n) & m in Ug) implies ( f . ( ( ( 2 * n ) + ( n * m ) ) + j ) ) = ( - 1 ))))
and
A10: (for m holds (m in ( UsedVx (g,n) ) implies ( g . ( n + m ) ) <> ( - 1 )));
set mi = ( ( ( n * n ) + ( 3 * n ) ) + 1 );
set Ak = ( Argmin (IN,g,n) );
A11: 1 <= mi by NAT_1:12;
A12: ( len f ) = mi by A1,CKB93:def 1;
A13: ( M . g ) = ( (g,mi) := (Ak,( - 1 )) ) by CKB54:def 1;
A14: ( dom ( M . g ) ) = ( dom g ) by CKB57:1;
h = ( R . ( M . g ) ) by A4,A5,CKB33:1;
then A15: h = ( Relax (( M . g ),n) ) by CKB65:def 1;
A16: ( Seg n ) = (the carrier of G) by A1,CKB93:def 1;
then reconsider VG = (the carrier of G) as non empty (Subset of ( NAT )) by A3;
A17: W is_weight>=0of G by GRAPH_5:def 13;
A18: ( ( 2 * n ) + n ) = ( ( 2 + 1 ) * n );
A19: ( dom f ) = ( dom g ) by A4,CKB74:1;
A20: 1 <= Ak by A6,CKB52:1;
A21: Ak <= n by A6,CKB52:1;
A22: ( g . ( n + Ak ) ) <> ( - 1 ) by A6,CKB52:1;
set Uh = ( UsedVx (h,n) );
A23: (Uh = ( Ug \/ { Ak } ) & (not Ak in Ug)) by A4,A5,A6,CKB70:1;
then A24: Ug c= Uh by XBOOLE_1:7;
A25: n < mi by CKB59:1;
A26: ( dom f ) = ( dom h ) by A5,CKB74:1;
reconsider vk = Ak as (Vertex of G) by A16,A20,A21,FINSEQ_1:1;
consider pk being (FinSequence of ( NAT )),PK being  oriented (Chain of G) such that A27: pk is_simple_vertex_seq_at g,Ak,n and A28: (for i holds ((1 <= i & i < ( len pk )) implies ( pk . i ) in Ug)) and A29: PK is_oriented_edge_seq_of pk and A30: PK is_shortestpath_of v1,vk,Ug,W and A31: ( cost (PK,W) ) = ( g . ( ( 2 * n ) + Ak ) ) and A32: ((not vk in Ug) implies PK islongestInShortestpath Ug,v1,W) by A2,A7,A8,A22,A23;
A33: (ex kk being (Element of ( NAT )) st (((kk = Ak & kk in IN) & (for i holds (i in IN implies ( g /. ( ( 2 * n ) + kk ) ) <= ( g /. ( ( 2 * n ) + i ) )))) & (for i holds ((i in IN & ( g /. ( ( 2 * n ) + kk ) ) = ( g /. ( ( 2 * n ) + i ) )) implies kk <= i)))) by A6,CKB51:def 1;
set nAk = ( ( 2 * n ) + Ak );
A34: 1 < nAk by A20,A21,CKB89:1;
A35: nAk < mi by A20,A21,CKB89:1;
A36: Ak < nAk by A20,A21,CKB89:1;
A37: nAk in ( dom g ) by A12,A19,A34,A35,FINSEQ_3:25;
A38: f,g equal_at ( ( 3 * n ) + 1 ),( ( n * n ) + ( 3 * n ) ) by A4,CKB80:1;
PK is_orientedpath_of v1,vk,Ug by A30,GRAPH_5:def 18;
then A39: PK is_orientedpath_of v1,vk by GRAPH_5:def 4;
then PK <> ( {} ) by GRAPH_5:def 3;
then A40: ( len PK ) >= 1 by FINSEQ_1:20;
A41: mi in ( dom g ) by A11,A12,A19,FINSEQ_3:25;
then A42: ( ( M . g ) /. mi ) = ( ( M . g ) . mi ) by A14,PARTFUN1:def 6
.= Ak by A13,A21,A25,A41,CKB24:1;
A43: ( ( M . g ) /. nAk ) = ( ( M . g ) . nAk ) by A14,A37,PARTFUN1:def 6
.= ( cost (PK,W) ) by A13,A31,A35,A36,CKB25:1;
set nk = ( n + Ak );
A44: 1 < nk by A20,A21,CKB90:1;
A45: nk <= ( 2 * n ) by A20,A21,CKB90:1;
A46: nk < mi by A20,A21,CKB90:1;
( n + 1 ) <= nk by A20,XREAL_1:7;
then A47: n < nk by NAT_1:13;
A48: nk in ( dom g ) by A12,A19,A44,A46,FINSEQ_3:25;
A49: ( ( M . g ) . nk ) = ( g . nk ) by A46,A47,CKB55:1;
now
set Wke = ( ( M . g ) /. ( ( ( 2 * n ) + ( n * ( ( M . g ) /. mi ) ) ) + Ak ) );
assume A50: ( M . g ) hasBetterPathAt n,Ak;
then A51: (( ( M . g ) . nk ) = ( - 1 ) or ( ( M . g ) /. nAk ) > ( newpathcost (( M . g ),n,Ak) )) by CKB63:def 1;
Wke >= ( 0 ) by A50,CKB63:def 1;
then ( ( ( M . g ) /. nAk ) + Wke ) >= ( ( ( M . g ) /. nAk ) + ( 0 ) ) by XREAL_1:7;
hence contradiction by A6,A42,A49,A51,CKB52:1;
end;
then (not ( M . g ) hasBetterPathAt n,( nk -' n )) by NAT_D:34;
then A52: ( h . nk ) = ( g . nk ) by A14,A15,A45,A47,A48,A49,CKB64:def 1;
hereby
let v3;
let j;
assume that
A53: v3 <> v1
and
A54: v3 = j
and
A55: ( h . ( n + j ) ) <> ( - 1 );
set nj = ( n + j );
A56: j in VG by A54;
then A57: 1 <= j by A16,FINSEQ_1:1;
A58: j <= n by A16,A56,FINSEQ_1:1;
then A59: 1 < nj by A57,CKB90:1;
A60: nj <= ( 2 * n ) by A57,A58,CKB90:1;
A61: nj < mi by A57,A58,CKB90:1;
then A62: nj in ( dom g ) by A12,A19,A59,FINSEQ_3:25;
A63: ( nj -' n ) = j by NAT_D:34;
( n + 1 ) <= nj by A57,XREAL_1:7;
then A64: n < nj by NAT_1:13;
set m2 = ( ( 2 * n ) + j );
A65: m2 <= ( 3 * n ) by A18,A58,XREAL_1:7;
( ( 2 * n ) + 1 ) <= m2 by A57,XREAL_1:7;
then A66: ( 2 * n ) < m2 by NAT_1:13;
A67: ( m2 -' ( 2 * n ) ) = j by NAT_D:34;
A68: 1 < m2 by A57,A58,CKB89:1;
A69: m2 < mi by A57,A58,CKB89:1;
then A70: m2 in ( dom g ) by A12,A19,A68,FINSEQ_3:25;
A71: m2 in ( dom ( M . g ) ) by A12,A14,A19,A68,A69,FINSEQ_3:25;
A72: ( ( M . g ) . nj ) = ( g . nj ) by A13,A21,A61,A64,CKB25:1;
n <= ( 2 * n ) by CKB58:1;
then n < m2 by A66,XXREAL_0:2;
then A73: ( ( M . g ) . m2 ) = ( g . m2 ) by A13,A21,A69,CKB25:1;
A74: j < mi by A25,A58,XXREAL_0:2;
then A75: j in ( dom g ) by A12,A19,A57,FINSEQ_3:25;
A76: j in ( dom h ) by A12,A26,A57,A74,FINSEQ_3:25;
set Akj = ( ( ( 2 * n ) + ( n * Ak ) ) + j );
A77: 1 < Akj by A20,A21,A58,CKB91:1;
A78: Ak < Akj by A20,A21,A58,CKB91:1;
A79: Akj < mi by A20,A21,A58,CKB91:1;
then A80: Akj in ( dom g ) by A12,A19,A77,FINSEQ_3:25;
A81: ( ( 3 * n ) + 1 ) <= Akj by A20,A21,A57,A58,CKB92:1;
A82: Akj <= ( ( n * n ) + ( 3 * n ) ) by A20,A21,A57,A58,CKB92:1;
A83: ( ( M . g ) /. ( ( ( 2 * n ) + ( n * ( ( M . g ) /. mi ) ) ) + j ) ) = ( ( M . g ) . Akj ) by A14,A42,A80,PARTFUN1:def 6
.= ( g . Akj ) by A13,A78,A79,CKB25:1
.= ( f . Akj ) by A19,A38,A80,A81,A82,CKB75:def 1
.= ( Weight (vk,v3,W) ) by A1,A54,CKB93:def 1;
A84: ( ( M . g ) /. m2 ) = ( g . m2 ) by A14,A70,A73,PARTFUN1:def 6;
per cases ;
suppose A85: (not ( M . g ) hasBetterPathAt n,( nj -' n ));

then A86: ( h . nj ) = ( g . nj ) by A14,A15,A60,A62,A64,A72,CKB64:def 1;
then consider p,P such that A87: p is_simple_vertex_seq_at g,j,n and A88: (for i holds ((1 <= i & i < ( len p )) implies ( p . i ) in Ug)) and A89: P is_oriented_edge_seq_of p and A90: P is_shortestpath_of v1,v3,Ug,W and A91: ( cost (P,W) ) = ( g . m2 ) and A92: ((not v3 in Ug) implies P islongestInShortestpath Ug,v1,W) by A8,A53,A54,A55;
take p;
take P;
thus p is_simple_vertex_seq_at h,j,n by A4,A5,A6,A12,A86,A87,A88,CKB97:1;
hereby
let i;
assume that
A93: 1 <= i
and
A94: i < ( len p );
( p . i ) in Ug by A88,A93,A94;
hence ( p . i ) in Uh by A24;
end;
thus P is_oriented_edge_seq_of p by A89;
hereby
per cases ;
suppose ( ( M . g ) . j ) = ( - 1 );

then ( ( Relax (( M . g ),n) ) . j ) = ( - 1 ) by A14,A58,A75,CKB64:def 1;
then j in { i: (((i in ( dom h ) & 1 <= i) & i <= n) & ( h . i ) = ( - 1 )) } by A15,A57,A58,A76;
then A95: (j in Ug or j in { Ak }) by A23,XBOOLE_0:def 3;
now
let Q;
let v4;
assume that
A96: (not v4 in Ug)
and
A97: Q is_shortestpath_of v1,v4,Ug,W;
A98: v4 in VG;
then reconsider j4 = v4 as (Element of ( NAT ));
A99: 1 <= j4 by A16,A98,FINSEQ_1:1;
A100: j4 <= n by A16,A98,FINSEQ_1:1;
then A101: ( g . ( n + j4 ) ) <> ( - 1 ) by A1,A2,A7,A9,A17,A96,A97,A99,CKB99:1;
then consider q,R such that q is_simple_vertex_seq_at g,j4,n and (for i holds ((1 <= i & i < ( len q )) implies ( q . i ) in Ug)) and R is_oriented_edge_seq_of q and A102: R is_shortestpath_of v1,v4,Ug,W and A103: ( cost (R,W) ) = ( g . ( ( 2 * n ) + j4 ) ) and A104: ((not v4 in Ug) implies R islongestInShortestpath Ug,v1,W) by A2,A7,A8,A96;
A105: ( cost (R,W) ) = ( cost (Q,W) ) by A97,A102,CKB11:1;
per cases  by A95,TARSKI:def 1;
suppose j in Ug;

then (ex PP being  oriented (Chain of G) st (PP is_shortestpath_of v1,v3,Ug,W & ( cost (PP,W) ) <= ( cost (R,W) ))) by A53,A54,A96,A104,GRAPH_5:def 19;
hence ( cost (P,W) ) <= ( cost (Q,W) ) by A90,A105,CKB11:1;
end;
suppose A106: j = Ak;

j4 <= mi by A25,A100,XXREAL_0:2;
then A107: j4 in ( dom g ) by A12,A19,A99,FINSEQ_3:25;
then ( g . j4 ) <> ( - 1 ) by A96,A99,A100;
then j4 in { i: ((((i in ( dom g ) & 1 <= i) & i <= n) & ( g . i ) <> ( - 1 )) & ( g . ( n + i ) ) <> ( - 1 )) } by A99,A100,A101,A107;
then A108: ( g /. ( ( 2 * n ) + Ak ) ) <= ( g /. ( ( 2 * n ) + j4 ) ) by A33;
A109: ( g /. ( ( 2 * n ) + Ak ) ) = ( g . ( ( 2 * n ) + Ak ) ) by A37,PARTFUN1:def 6;
A110: 1 < ( ( 2 * n ) + j4 ) by A99,A100,CKB89:1;
( ( 2 * n ) + j4 ) < mi by A99,A100,CKB89:1;
then ( ( 2 * n ) + j4 ) in ( dom g ) by A12,A19,A110,FINSEQ_3:25;
hence ( cost (P,W) ) <= ( cost (Q,W) ) by A91,A103,A105,A106,A108,A109,PARTFUN1:def 6;
end;
end;
hence P is_shortestpath_of v1,v3,Uh,W by A17,A24,A53,A90,GRAPH_5:64;
end;
suppose A111: ( ( M . g ) . j ) <> ( - 1 );

hereby
per cases ;
suppose A112: ( ( M . g ) /. ( ( ( 2 * n ) + ( n * ( ( M . g ) /. mi ) ) ) + j ) ) >= ( 0 );

then A113: ( ( M . g ) /. m2 ) <= ( newpathcost (( M . g ),n,j) ) by A63,A85,A111,CKB63:def 1;
A114: ( ( M . g ) /. m2 ) = ( cost (P,W) ) by A71,A73,A91,PARTFUN1:def 6;
consider e being set such that A115: e in (the carrier' of G) and A116: e orientedly_joins vk,v3 by A83,A112,CKB41:1;
reconsider pe = <* e *> as  oriented (Chain of G) by A115,CKB5:1;
A117: ( len pe ) = 1 by FINSEQ_1:40;
A118: ( pe . 1 ) = e by FINSEQ_1:40;
then consider Q such that A119: Q = ( PK ^ pe ) and Q is_orientedpath_of v1,v3 by A39,A40,A116,A117,GRAPH_5:33;
( cost (pe,W) ) = ( W . ( pe . 1 ) ) by A17,A117,CKB4:1,GRAPH_5:46
.= ( Weight (vk,v3,W) ) by A115,A116,A118,CKB43:1;
then ( cost (Q,W) ) = ( newpathcost (( M . g ),n,j) ) by A17,A42,A43,A83,A119,GRAPH_5:46,GRAPH_5:54;
hence P is_shortestpath_of v1,v3,Uh,W by A2,A7,A17,A23,A30,A32,A40,A53,A90,A113,A114,A115,A116,A119,GRAPH_5:65;
end;
suppose ( ( M . g ) /. ( ( ( 2 * n ) + ( n * ( ( M . g ) /. mi ) ) ) + j ) ) < ( 0 );

then (not (ex e being set st (e in (the carrier' of G) & e orientedly_joins vk,v3))) by A83,CKB41:1;
hence P is_shortestpath_of v1,v3,Uh,W by A2,A7,A17,A23,A30,A32,A53,A90,CKB17:1;
end;
end;
end;
end;
thus ( cost (P,W) ) = ( h . m2 ) by A15,A63,A65,A66,A67,A71,A73,A85,A91,CKB64:def 1;
hereby
assume A120: (not v3 in Uh);
then A121: (not v3 in Ug) by A23,XBOOLE_0:def 3;
now
let v2;
assume that
A122: v2 in Uh
and
A123: v2 <> v1;
per cases  by A23,A122,XBOOLE_0:def 3;
suppose v2 in { Ak };

then A124: v2 = vk by TARSKI:def 1;
take PK;
thus PK is_shortestpath_of v1,v2,Uh,W by A23,A30,A124,CKB10:1;
( g . j ) <> ( - 1 ) by A54,A57,A58,A75,A121;
then j in { i: ((((i in ( dom g ) & 1 <= i) & i <= n) & ( g . i ) <> ( - 1 )) & ( g . ( n + i ) ) <> ( - 1 )) } by A55,A57,A58,A75,A86;
then A125: ( g /. nAk ) <= ( g /. m2 ) by A33;
( g /. nAk ) = ( cost (PK,W) ) by A31,A37,PARTFUN1:def 6;
hence ( cost (PK,W) ) <= ( cost (P,W) ) by A70,A91,A125,PARTFUN1:def 6;
end;
suppose A126: v2 in Ug;

then consider Q such that A127: Q is_shortestpath_of v1,v2,Ug,W and A128: ( cost (Q,W) ) <= ( cost (P,W) ) by A23,A92,A120,A123,GRAPH_5:def 19,XBOOLE_0:def 3;
A129:now
let R;
let v4;
assume that
A130: (not v4 in Ug)
and
A131: R is_shortestpath_of v1,v4,Ug,W;
A132: v4 in VG;
then reconsider j4 = v4 as (Element of ( NAT ));
A133: 1 <= j4 by A16,A132,FINSEQ_1:1;
j4 <= n by A16,A132,FINSEQ_1:1;
then ( g . ( n + j4 ) ) <> ( - 1 ) by A1,A2,A7,A9,A17,A130,A131,A133,CKB99:1;
then consider rn being (FinSequence of ( NAT )),RR being  oriented (Chain of G) such that rn is_simple_vertex_seq_at g,j4,n and (for i holds ((1 <= i & i < ( len rn )) implies ( rn . i ) in Ug)) and RR is_oriented_edge_seq_of rn and A134: RR is_shortestpath_of v1,v4,Ug,W and ( cost (RR,W) ) = ( g . ( ( 2 * n ) + j4 ) ) and A135: ((not v4 in Ug) implies RR islongestInShortestpath Ug,v1,W) by A2,A7,A8,A130;
consider QQ being  oriented (Chain of G) such that A136: QQ is_shortestpath_of v1,v2,Ug,W and A137: ( cost (QQ,W) ) <= ( cost (RR,W) ) by A123,A126,A130,A135,GRAPH_5:def 19;
( cost (QQ,W) ) = ( cost (Q,W) ) by A127,A136,CKB11:1;
hence ( cost (Q,W) ) <= ( cost (R,W) ) by A131,A134,A137,CKB11:1;
end;
take Q;
thus Q is_shortestpath_of v1,v2,Uh,W by A17,A24,A123,A127,A129,GRAPH_5:64;
thus ( cost (Q,W) ) <= ( cost (P,W) ) by A128;
end;
end;
hence P islongestInShortestpath Uh,v1,W by GRAPH_5:def 19;
end;
end;
suppose A138: ( M . g ) hasBetterPathAt n,( nj -' n );

then A139: ( ( Relax (( M . g ),n) ) . nj ) = Ak by A14,A42,A60,A62,A64,CKB64:def 1;
A140: (( ( M . g ) . nj ) = ( - 1 ) or ( ( M . g ) /. m2 ) > ( newpathcost (( M . g ),n,j) )) by A63,A138,CKB63:def 1;
A141: ( ( M . g ) /. ( ( ( 2 * n ) + ( n * ( ( M . g ) /. mi ) ) ) + j ) ) >= ( 0 ) by A63,A138,CKB63:def 1;
A142: ( ( M . g ) . j ) <> ( - 1 ) by A63,A138,CKB63:def 1;
A143: ( newpathcost (( M . g ),n,j) ) = ( ( ( M . g ) /. nAk ) + ( Weight (vk,v3,W) ) ) by A42,A83;
A144:now
assume A145: Ak = j;
then A146: ( ( M . g ) . nj ) <> ( - 1 ) by A13,A21,A22,A61,A64,CKB25:1;
( ( ( M . g ) /. m2 ) + ( Weight (vk,v3,W) ) ) >= ( ( ( M . g ) /. m2 ) + ( 0 ) ) by A83,A141,XREAL_1:7;
hence contradiction by A63,A138,A143,A145,A146,CKB63:def 1;
end;
A147:now
assume j in ( UsedVx (g,n) );
then (ex i st ((((j = i & i in ( dom g )) & 1 <= i) & i <= n) & ( g . i ) = ( - 1 )));
hence contradiction by A25,A142,CKB56:1;
end;
consider e being set such that A148: (e in (the carrier' of G) & e orientedly_joins vk,v3) by A83,A141,CKB41:1;
reconsider pe = <* e *> as  oriented (Chain of G) by A148,CKB5:1;
A149: ( len pe ) = 1 by FINSEQ_1:40;
A150: ( pe . 1 ) = e by FINSEQ_1:40;
then consider Q such that A151: Q = ( PK ^ pe ) and Q is_orientedpath_of v1,v3 by A39,A40,A148,A149,GRAPH_5:33;
take q = ( pk ^ <* j *> );
take Q;
thus q is_simple_vertex_seq_at h,j,n by A4,A5,A6,A12,A15,A27,A28,A52,A139,A144,A147,CKB98:1;
A152: ( len pk ) > 1 by A27,CKB84:def 1;
A153: pk is_vertex_seq_at g,Ak,n by A27,CKB84:def 1;
A154: ( q . ( len pk ) ) = ( pk . ( len pk ) ) by A152,CKB6:1
.= Ak by A153,CKB83:def 1;
hereby
let i;
assume that
A155: 1 <= i
and
A156: i < ( len q );
i < ( ( len pk ) + 1 ) by A156,FINSEQ_2:16;
then A157: i <= ( len pk ) by NAT_1:13;
now
per cases ;
suppose i = ( len pk );

hence (( q . i ) in { Ak } or ( q . i ) in Ug) by A154,TARSKI:def 1;
end;
suppose i <> ( len pk );

then A158: i < ( len pk ) by A157,XXREAL_0:1;
( q . i ) = ( pk . i ) by A155,A157,CKB6:1;
hence (( q . i ) in { Ak } or ( q . i ) in Ug) by A28,A155,A158;
end;
end;
hence ( q . i ) in Uh by A23,XBOOLE_0:def 3;
end;
A159: ( len Q ) = ( ( len PK ) + 1 ) by A149,A151,FINSEQ_1:22;
A160: ( len pk ) = ( ( len PK ) + 1 ) by A29,CKB86:def 1;
then A161: ( len q ) = ( ( len Q ) + 1 ) by A159,FINSEQ_2:16;
set FS = (the Source of G);
set FT = (the Target of G);
now
let i being Nat;
assume that
A162: 1 <= i
and
A163: i <= ( len Q );
per cases ;
suppose A164: i = ( len Q );

then A165: ( Q . i ) = e by A149,A150,A151,A159,CKB7:1;
then A166: ( FT . ( Q . i ) ) = v3 by A148,GRAPH_4:def 1;
thus ( FS . ( Q . i ) ) = ( q . i ) by A148,A154,A159,A160,A164,A165,GRAPH_4:def 1;
thus ( FT . ( Q . i ) ) = ( q . ( i + 1 ) ) by A54,A159,A160,A164,A166,FINSEQ_1:42;
end;
suppose i <> ( len Q );

then A167: i < ( len Q ) by A163,XXREAL_0:1;
then A168: i <= ( len PK ) by A159,NAT_1:13;
then A169: ( FS . ( PK . i ) ) = ( pk . i ) by A29,A162,CKB86:def 1;
A170: ( FT . ( PK . i ) ) = ( pk . ( i + 1 ) ) by A29,A162,A168,CKB86:def 1;
A171: ( Q . i ) = ( PK . i ) by A151,A162,A168,CKB6:1;
A172: ( i + 1 ) <= ( len pk ) by A159,A160,A167,NAT_1:13;
thus ( FS . ( Q . i ) ) = ( q . i ) by A159,A160,A162,A163,A169,A171,CKB6:1;
thus ( FT . ( Q . i ) ) = ( q . ( i + 1 ) ) by A170,A171,A172,CKB6:1,NAT_1:12;
end;
end;
hence Q is_oriented_edge_seq_of q by A161,CKB86:def 1;
A173: ( ( cost (PK,W) ) + ( cost (pe,W) ) ) = ( cost (Q,W) ) by A17,A151,GRAPH_5:46,GRAPH_5:54;
A174: ( cost (pe,W) ) = ( W . ( pe . 1 ) ) by A17,A149,CKB4:1,GRAPH_5:46
.= ( Weight (vk,v3,W) ) by A148,A150,CKB43:1;
then A175: ( newpathcost (( M . g ),n,j) ) = ( cost (Q,W) ) by A17,A42,A43,A83,A151,GRAPH_5:46,GRAPH_5:54;
hereby
per cases ;
suppose A176: ( g . nj ) = ( - 1 );

now
let v2;
assume A177: v2 in Ug;
then reconsider m = v2 as (Element of ( NAT ));
( - 1 ) = ( f . ( ( ( 2 * n ) + ( n * m ) ) + j ) ) by A9,A57,A58,A176,A177
.= ( Weight (v2,v3,W) ) by A1,A54,CKB93:def 1;
hence (not (ex e being set st (e in (the carrier' of G) & e orientedly_joins v2,v3))) by CKB41:1;
end;
hence Q is_shortestpath_of v1,v3,Uh,W by A2,A7,A23,A30,A53,A148,A151,CKB19:1;
end;
suppose A178: ( g . nj ) <> ( - 1 );

then (ex p st (ex P st (((((p is_simple_vertex_seq_at g,j,n & (for i holds ((1 <= i & i < ( len p )) implies ( p . i ) in Ug))) & P is_oriented_edge_seq_of p) & P is_shortestpath_of v1,v3,Ug,W) & ( cost (P,W) ) = ( g . m2 )) & ((not v3 in Ug) implies P islongestInShortestpath Ug,v1,W)))) by A8,A53,A54;
hence Q is_shortestpath_of v1,v3,Uh,W by A2,A7,A13,A17,A21,A23,A30,A32,A40,A42,A43,A53,A61,A64,A83,A84,A140,A148,A151,A173,A174,A178,CKB25:1,GRAPH_5:65;
end;
end;
thus ( cost (Q,W) ) = ( h . m2 ) by A15,A63,A65,A66,A67,A71,A138,A175,CKB64:def 1;
( 0 ) <= ( cost (pe,W) ) by A17,GRAPH_5:50;
then A179: ( ( cost (PK,W) ) + ( 0 ) ) <= ( cost (Q,W) ) by A173,XREAL_1:7;
hereby
assume (not v3 in Uh);
now
let v2;
assume that
A180: v2 in Uh
and
A181: v2 <> v1;
per cases  by A23,A180,XBOOLE_0:def 3;
suppose v2 in { Ak };

then A182: v2 = Ak by TARSKI:def 1;
take PK;
thus PK is_shortestpath_of v1,v2,Uh,W by A23,A30,A182,CKB10:1;
thus ( cost (PK,W) ) <= ( cost (Q,W) ) by A179;
end;
suppose A183: v2 in Ug;

then consider P such that A184: P is_shortestpath_of v1,v2,Ug,W and A185: ( cost (P,W) ) <= ( cost (PK,W) ) by A4,A5,A6,A32,A181,CKB70:1,GRAPH_5:def 19;
A186:now
let R;
let v4;
assume that
A187: (not v4 in Ug)
and
A188: R is_shortestpath_of v1,v4,Ug,W;
A189: v4 in VG;
then reconsider j4 = v4 as (Element of ( NAT ));
A190: 1 <= j4 by A16,A189,FINSEQ_1:1;
j4 <= n by A16,A189,FINSEQ_1:1;
then ( g . ( n + j4 ) ) <> ( - 1 ) by A1,A2,A7,A9,A17,A187,A188,A190,CKB99:1;
then consider rn being (FinSequence of ( NAT )),RR being  oriented (Chain of G) such that rn is_simple_vertex_seq_at g,j4,n and (for i holds ((1 <= i & i < ( len rn )) implies ( rn . i ) in Ug)) and RR is_oriented_edge_seq_of rn and A191: RR is_shortestpath_of v1,v4,Ug,W and ( cost (RR,W) ) = ( g . ( ( 2 * n ) + j4 ) ) and A192: ((not v4 in Ug) implies RR islongestInShortestpath Ug,v1,W) by A2,A7,A8,A187;
consider PP being  oriented (Chain of G) such that A193: PP is_shortestpath_of v1,v2,Ug,W and A194: ( cost (PP,W) ) <= ( cost (RR,W) ) by A181,A183,A187,A192,GRAPH_5:def 19;
( cost (PP,W) ) = ( cost (P,W) ) by A184,A193,CKB11:1;
hence ( cost (P,W) ) <= ( cost (R,W) ) by A188,A191,A194,CKB11:1;
end;
take P;
thus P is_shortestpath_of v1,v2,Uh,W by A17,A24,A181,A184,A186,GRAPH_5:64;
thus ( cost (P,W) ) <= ( cost (Q,W) ) by A179,A185,XXREAL_0:2;
end;
end;
hence Q islongestInShortestpath Uh,v1,W by GRAPH_5:def 19;
end;
end;
end;
hereby
let m;
let j;
assume that
A195: ( h . ( n + j ) ) = ( - 1 )
and
A196: 1 <= j
and
A197: j <= n
and
A198: m in Uh;
set nj = ( n + j );
A199: 1 < nj by A196,A197,CKB90:1;
A200: nj <= ( 2 * n ) by A196,A197,CKB90:1;
A201: nj < mi by A196,A197,CKB90:1;
then A202: nj in ( dom g ) by A12,A19,A199,FINSEQ_3:25;
( n + 1 ) <= nj by A196,XREAL_1:7;
then A203: n < nj by NAT_1:13;
A204:now
assume ( M . g ) hasBetterPathAt n,( nj -' n );
then ( h . nj ) = Ak by A14,A15,A42,A200,A202,A203,CKB64:def 1;
hence contradiction by A195,NAT_1:2;
end;
A205: ( ( M . g ) . nj ) = ( g . nj ) by A13,A21,A201,A203,CKB25:1;
then A206: ( g . nj ) = ( - 1 ) by A14,A15,A195,A200,A202,A203,A204,CKB64:def 1;
then A207: (not j in Ug) by A10;
j < mi by A25,A197,XXREAL_0:2;
then j in ( dom g ) by A12,A19,A196,FINSEQ_3:25;
then ( g . j ) <> ( - 1 ) by A196,A197,A207;
then A208: ( ( M . g ) . j ) <> ( - 1 ) by A13,A22,A25,A197,A206,CKB25:1;
(not ( M . g ) hasBetterPathAt n,j) by A204,NAT_D:34;
then A209: ( ( M . g ) /. ( ( ( 2 * n ) + ( n * ( ( M . g ) /. mi ) ) ) + j ) ) < ( 0 ) by A205,A206,A208,CKB63:def 1;
reconsider v3 = j as (Vertex of G) by A16,A196,A197,FINSEQ_1:1;
set Akj = ( ( ( 2 * n ) + ( n * Ak ) ) + j );
A210: 1 < Akj by A20,A21,A197,CKB91:1;
A211: Ak < Akj by A20,A21,A197,CKB91:1;
A212: Akj < mi by A20,A21,A197,CKB91:1;
then A213: Akj in ( dom g ) by A12,A19,A210,FINSEQ_3:25;
A214: ( ( 3 * n ) + 1 ) <= Akj by A20,A21,A196,A197,CKB92:1;
A215: Akj <= ( ( n * n ) + ( 3 * n ) ) by A20,A21,A196,A197,CKB92:1;
A216: ( f . Akj ) = ( Weight (vk,v3,W) ) by A1,CKB93:def 1;
A217: ( ( M . g ) /. ( ( ( 2 * n ) + ( n * ( ( M . g ) /. mi ) ) ) + j ) ) = ( ( M . g ) . Akj ) by A14,A42,A213,PARTFUN1:def 6
.= ( g . Akj ) by A13,A211,A212,CKB25:1
.= ( Weight (vk,v3,W) ) by A19,A38,A213,A214,A215,A216,CKB75:def 1;
per cases  by A23,A198,XBOOLE_0:def 3;
suppose m in { Ak };

then A218: m = Ak by TARSKI:def 1;
(not (ex e being set st (e in (the carrier' of G) & e orientedly_joins vk,v3))) by A209,A217,CKB41:1;
then ( Weight (vk,v3,W) ) = ( - 1 ) by CKB39:def 1;
hence ( f . ( ( ( 2 * n ) + ( n * m ) ) + j ) ) = ( - 1 ) by A1,A218,CKB93:def 1;
end;
suppose m in Ug;

hence ( f . ( ( ( 2 * n ) + ( n * m ) ) + j ) ) = ( - 1 ) by A9,A196,A197,A206;
end;
end;
let m;
assume A219: m in Uh;
per cases  by A23,A219,XBOOLE_0:def 3;
suppose A220: m in Ug;

then ( h . ( n + m ) ) = ( g . ( n + m ) ) by A4,A5,A6,A12,CKB96:1;
hence thesis by A10,A220;
end;
suppose m in { Ak };

hence thesis by A22,A52,TARSKI:def 1;
end;
end;
