environ
vocabularies NUMBERS,NAT_1,INT_1,XXREAL_0,RELAT_1,ARYTM_3,CARD_1,NEWTON,ARYTM_1,INT_2,SUBSET_1,SQUARE_1,ORDINAL1,ABIAN,POWER,EULER_1,TARSKI,SETWOP_2,FINSET_1,XBOOLE_0,XREAL_0,PEPIN;
notations TARSKI,XBOOLE_0,SUBSET_1,ORDINAL1,CARD_1,NUMBERS,XCMPLX_0,XREAL_0,INT_1,INT_2,NAT_1,NAT_D,SETWOP_2,POWER,ABIAN,SQUARE_1,NEWTON,EULER_1,FINSET_1,XXREAL_0,CKB10,CKB51,CKB59;
definitions TARSKI,INT_1,SQUARE_1,CKB59;
theorems NAT_1,NAT_2,INT_1,INT_2,FINSEQ_1,EULER_1,EULER_2,PREPOWER,PRE_FF,POWER,NEWTON,XCMPLX_0,XCMPLX_1,XREAL_1,XXREAL_0,ORDINAL1,NAT_D,XREAL_0,CKB1,CKB2,CKB3,CKB4,CKB5,CKB6,CKB7,CKB8,CKB11,CKB12,CKB13,CKB14,CKB15,CKB16,CKB17,CKB18,CKB19,CKB20,CKB21,CKB22,CKB23,CKB24,CKB25,CKB26,CKB27,CKB28,CKB29,CKB30,CKB31,CKB32,CKB33,CKB34,CKB35,CKB36,CKB37,CKB38,CKB39,CKB40,CKB41,CKB42,CKB43,CKB44,CKB45,CKB46,CKB47,CKB48,CKB49,CKB50,CKB52,CKB53,CKB54,CKB55,CKB56,CKB57,CKB58,CKB59;
schemes NAT_1;
registrations ORDINAL1,FINSET_1,FINSUB_1,XXREAL_0,XREAL_0,NAT_1,INT_1,NEWTON,ABIAN,SERIES_1,XBOOLE_0,POWER,CARD_1,CKB9;
constructors SQUARE_1,NAT_1,NAT_D,SETWOP_2,NEWTON,SERIES_1,BINARITH,EULER_1,ABIAN,VALUED_1,XXREAL_2,CKB10,CKB51,CKB59;
requirements REAL,NUMERALS,SUBSET,BOOLE,ARITHM;
begin
reserve k for Nat;
reserve m for Nat;
reserve n for Nat;
reserve p for Nat;
reserve q for Nat;
reserve k1 for Nat;
reserve k2 for Nat;
theorem
((((((p is  prime & q is  prime) & p <> q) & n = ( p * q )) & k1,( Euler n ) are_relative_prime ) & ( ( k1 * k2 ) mod ( Euler n ) ) = 1) implies (for m being (Element of ( NAT )) holds (m < n implies ( Crypto (( Crypto (m,n,k1) ),n,k2) ) = m)))
proof
assume that
A1: p is  prime
and
A2: q is  prime
and
A3: p <> q
and
A4: n = ( p * q )
and
A5: k1,( Euler n ) are_relative_prime 
and
A6: ( ( k1 * k2 ) mod ( Euler n ) ) = 1;
A7: q > 1 by A2,INT_2:def 4;
A8: p > 1 by A1,INT_2:def 4;
then A9: ( Euler n ) = ( ( Euler p ) * ( Euler q ) ) by A1,A2,A3,A4,A7,EULER_1:21,INT_2:30
.= ( ( p - 1 ) * ( Euler q ) ) by A1,EULER_1:20
.= ( ( p - 1 ) * ( q - 1 ) ) by A2,EULER_1:20;
A10: n > 1 by A4,A8,A7,XREAL_1:161;
A11: (p <> ( 0 ) & q <> ( 0 )) by A1,A2,INT_2:def 4;
then reconsider p1 = ( p - 1 ),q1 = ( q - 1 ) as (Element of ( NAT )) by CKB3:1,INT_1:3;
n <> ( 0 ) by A4,A11,XCMPLX_1:6;
then A12: ( Euler n ) <> ( 0 ) by CKB56:1;
(not (p1 = 1 & q1 = 1)) by A3;
then A13: ( p1 * q1 ) <> 1 by NAT_1:15;
A14: k1 <> ( 0 )
proof
assume k1 = ( 0 );
then ( k1 gcd ( Euler n ) ) = ( Euler n ) by NEWTON:52;
hence contradiction by A5,A9,A13,INT_2:def 3;
end;
A15: k2 <> ( 0 ) by A6,NAT_D:26;
A16: q > ( 0 ) by A2,INT_2:def 4;
let m being (Element of ( NAT ));
assume A17: m < n;
A18: p > ( 0 ) by A1,INT_2:def 4;
now
per cases ;
suppose A19: m = ( 0 );

then ( m |^ k1 ) = ( 0 ) by A14,NAT_1:14,NEWTON:11;
then ( ( m |^ k1 ) mod n ) = ( 0 ) by NAT_D:26;
then ( ( Crypto (m,n,k1) ) |^ k2 ) = ( 0 ) by A15,NAT_1:14,NEWTON:11;
hence thesis by A19,NAT_D:26;
end;
suppose A20: m = 1;

then ( m |^ k1 ) = 1 by NEWTON:10;
then ( ( m |^ k1 ) mod n ) = 1 by A10,NAT_D:14;
then ( ( Crypto (m,n,k1) ) |^ k2 ) = 1 by NEWTON:10;
hence thesis by A10,A20,NAT_D:14;
end;
suppose A21: (m <> ( 0 ) & m <> 1);

A22: (for t being (Element of ( NAT )) holds ( ( m |^ ( ( ( t * p1 ) * q1 ) + 1 ) ) mod n ) = m)
proof
let t being (Element of ( NAT ));
now
( m |^ ( ( t * p1 ) * q1 ) ) >= 1 by A21,NAT_1:14,PREPOWER:11;
then ( ( m |^ ( ( t * p1 ) * q1 ) ) - 1 ) >= ( 1 - 1 ) by XREAL_1:9;
then reconsider a = ( ( m |^ ( ( t * p1 ) * q1 ) ) - 1 ) as (Element of ( NAT )) by INT_1:3;
A23: p divides ( m * a )
proof
now
per cases ;
suppose ( m gcd p ) = 1;

then A24: m,p are_relative_prime  by INT_2:def 3;
( m |^ ( t * q1 ) ) <> ( 0 ) by A21,PREPOWER:5;
then ( ( ( m |^ ( t * q1 ) ) |^ ( p1 + 1 ) ) mod p ) = ( ( m |^ ( t * q1 ) ) mod p ) by A1,A21,A24,EULER_2:17,EULER_2:19;
then ( ( ( ( m |^ ( t * q1 ) ) |^ p1 ) * ( m |^ ( t * q1 ) ) ) mod p ) = ( ( m |^ ( t * q1 ) ) mod p ) by NEWTON:6;
then ( ( ( m |^ ( t * q1 ) ) |^ p1 ) mod p ) = 1 by A8,A21,A24,CKB17:1,EULER_2:17;
then ( ( m |^ ( ( t * q1 ) * p1 ) ) mod p ) = 1 by NEWTON:9;
then ( m |^ ( ( t * p1 ) * q1 ) ) = ( ( p * ( ( m |^ ( ( t * p1 ) * q1 ) ) div p ) ) + 1 ) by A18,NAT_D:2;
then p divides a by NAT_D:def 3;
hence thesis by NAT_D:9;
end;
suppose ( m gcd p ) <> 1;

then (not m,p are_relative_prime ) by INT_2:def 3;
then ( m gcd p ) = p by A1,CKB6:1;
then p divides m by NAT_D:def 5;
hence thesis by NAT_D:9;
end;
end;
hence thesis;
end;
q divides ( m * a )
proof
now
per cases ;
suppose ( m gcd q ) = 1;

then A25: m,q are_relative_prime  by INT_2:def 3;
( m |^ ( t * p1 ) ) <> ( 0 ) by A21,PREPOWER:5;
then ( ( ( m |^ ( t * p1 ) ) |^ ( q1 + 1 ) ) mod q ) = ( ( m |^ ( t * p1 ) ) mod q ) by A2,A21,A25,EULER_2:17,EULER_2:19;
then ( ( ( ( m |^ ( t * p1 ) ) |^ q1 ) * ( m |^ ( t * p1 ) ) ) mod q ) = ( ( m |^ ( t * p1 ) ) mod q ) by NEWTON:6;
then ( ( ( m |^ ( t * p1 ) ) |^ q1 ) mod q ) = 1 by A7,A21,A25,CKB17:1,EULER_2:17;
then ( ( m |^ ( ( t * p1 ) * q1 ) ) mod q ) = 1 by NEWTON:9;
then ( m |^ ( ( t * p1 ) * q1 ) ) = ( ( q * ( ( m |^ ( ( t * p1 ) * q1 ) ) div q ) ) + 1 ) by A16,NAT_D:2;
then q divides a by NAT_D:def 3;
hence thesis by NAT_D:9;
end;
suppose ( m gcd q ) <> 1;

then (not m,q are_relative_prime ) by INT_2:def 3;
then ( m gcd q ) = q by A2,CKB6:1;
then q divides m by NAT_D:def 5;
hence thesis by NAT_D:9;
end;
end;
hence thesis;
end;
then ( p * q ) divides ( m * a ) by A1,A2,A3,A23,CKB8:1,INT_2:30;
then consider k being Nat such that A26: ( m * a ) = ( ( p * q ) * k ) by NAT_D:def 3;
( m * ( ( m |^ ( ( t * p1 ) * q1 ) ) - 1 ) ) = ( ( m * ( m |^ ( ( t * p1 ) * q1 ) ) ) - ( m * 1 ) )
.= ( ( m |^ ( ( ( t * p1 ) * q1 ) + 1 ) ) - m ) by NEWTON:6;
then ( ( m |^ ( ( ( t * p1 ) * q1 ) + 1 ) ) - ( m - m ) ) = ( ( n * k ) + m ) by A4,A26,XCMPLX_1:37;
hence thesis by A17,NAT_D:def 2;
end;
hence thesis;
end;
reconsider t = ( ( k1 * k2 ) div ( Euler n ) ) as (Element of ( NAT ));
( k1 * k2 ) = ( ( ( p1 * q1 ) * t ) + 1 ) by A6,A12,A9,NAT_D:2
.= ( ( ( t * p1 ) * q1 ) + 1 );
then ( ( m |^ ( k1 * k2 ) ) mod n ) = m by A22;
then ( ( ( m |^ k1 ) |^ k2 ) mod n ) = m by NEWTON:9;
hence thesis by CKB18:1;
end;
end;
hence thesis;
end;
