environ
vocabularies NUMBERS,FINSET_1,XBOOLE_0,SUBSET_1,TARSKI,FUNCT_1,RELAT_1,FUNCOP_1,FUNCT_4,PBOOLE,FINSEQ_1,CARD_3,PARTFUN1,FUNCT_5,FUNCT_2,ZFMISC_1,FUNCT_6,NAT_1,CARD_1,ARYTM_3,MCART_1,FINSEQ_2,TREES_1,TREES_3,TREES_2,ORDINAL4,TREES_A,XXREAL_0,TREES_4,ARYTM_1;
notations TARSKI,XBOOLE_0,ZFMISC_1,SUBSET_1,NUMBERS,XCMPLX_0,XREAL_0,MCART_1,CARD_1,RELAT_1,FUNCT_1,FINSET_1,PARTFUN1,FUNCT_2,XXREAL_0,XXREAL_2,BINOP_1,FUNCOP_1,FUNCT_4,FUNCT_7,CARD_3,TREES_2,TREES_1,TREES_3,TREES_4,FUNCT_5,FUNCT_6,PBOOLE,FINSEQ_1,FINSEQ_2,NAT_1;
definitions TARSKI,FUNCOP_1,WELLORD2,FUNCT_1,RELAT_1,PBOOLE,XBOOLE_0,SEQ_4,FINSEQ_2,FINSET_1;
theorems TARSKI,ZFMISC_1,FINSEQ_1,FINSEQ_3,GRFUNC_1,FUNCT_1,FUNCT_2,FUNCT_4,FUNCT_5,TREES_1,TREES_2,TREES_3,TREES_4,NAT_1,RELAT_1,CARD_3,FUNCOP_1,MCART_1,PBOOLE,CARD_2,CARD_1,FUNCT_6,FINSET_1,XBOOLE_0,XBOOLE_1,XCMPLX_1,ORDERS_1,XREAL_1,XXREAL_0,XXREAL_2,XREAL_0,PARTFUN1,FUNCT_7,FINSEQ_2,CKB2,CKB3,CKB9,CKB10,CKB11,CKB14,CKB15,CKB16,CKB19,CKB21,CKB22,CKB23,CKB24,CKB25;
schemes DOMAIN_1,PBOOLE,FUNCT_1,FRAENKEL,FINSEQ_1,NAT_1,CKB1,CKB4,CKB12,CKB13;
registrations XBOOLE_0,SUBSET_1,RELAT_1,FUNCT_1,ORDINAL1,FUNCOP_1,FINSET_1,XREAL_0,MEMBERED,FINSEQ_1,CARD_3,PBOOLE,TREES_2,TREES_3,XXREAL_2,CARD_1,RELSET_1,TREES_1,CKB5,CKB6,CKB7,CKB8,CKB17,CKB18,CKB20;
constructors WELLORD2,BINOP_1,FUNCT_4,SETWISEO,XXREAL_0,NAT_1,FUNCT_5,CARD_3,SEQ_4,PBOOLE,TREES_4,BINARITH,INT_1,SEQ_1,XXREAL_2,PARTFUN1,RELSET_1,FUNCT_7;
requirements NUMERALS,REAL,BOOLE,SUBSET,ARITHM;
begin
reserve x for set;
theorem
(for e1,e2 being  finite DecoratedTree holds (for x being set holds (for k being (Element of ( NAT )) holds (for p being  DTree-yielding FinSequence holds ((<* k *> in ( dom e1 ) & e1 = ( x -tree p )) implies (ex q being  DTree-yielding FinSequence st (((( e1 with-replacement (<* k *>,e2) ) = ( x -tree q ) & ( len q ) = ( len p )) & ( q . ( k + 1 ) ) = e2) & (for i being (Element of ( NAT )) holds ((i in ( dom p ) & i <> ( k + 1 )) implies ( q . i ) = ( p . i ))))))))))
proof
let e1 being  finite DecoratedTree,e2 being  finite DecoratedTree;
let x being set;
let k being (Element of ( NAT ));
let p being  DTree-yielding FinSequence;
assume that
A1: <* k *> in ( dom e1 )
and
A2: e1 = ( x -tree p );
consider j being (Element of ( NAT )),T being DecoratedTree,w being (Node of T) such that A3: j < ( len p ) and T = ( p . ( j + 1 ) ) and A4: <* k *> = ( <* j *> ^ w ) by A1,A2,TREES_4:11;
consider pp being  DTree-yielding FinSequence such that A5: p = pp and A6: ( dom ( x -tree p ) ) = ( tree ( doms pp ) ) by TREES_4:def 4;
A7: ( dom ( doms pp ) ) = ( dom p ) by A5,TREES_3:37;
deffunc F(Nat) = ( IFEQ ($1,( k + 1 ),e2,( p . $1 )) );
set o = <* k *>;
consider q being FinSequence such that A8: ( len q ) = ( len p ) and A9: (for i being Nat holds (i in ( dom q ) implies ( q . i ) = F(i))) from FINSEQ_1:sch 2;
A10: ( dom q ) = ( Seg ( len p ) ) by A8,FINSEQ_1:def 3;
A11: ( dom q ) = ( dom p ) by A8,FINSEQ_3:29;
now
let x;
assume A12: x in ( dom q );
then reconsider i = x as (Element of ( NAT ));
A13: (i = ( k + 1 ) or i <> ( k + 1 ));
( q . i ) = ( IFEQ (i,( k + 1 ),e2,( p . i )) ) by A9,A12;
then (( q . i ) = e2 or ( q . i ) = ( p . i )) by A13,FUNCOP_1:def 8;
hence ( q . x ) is DecoratedTree by A11,A12,TREES_3:24;
end;
then reconsider q as  DTree-yielding FinSequence by TREES_3:24;
consider qq being  DTree-yielding FinSequence such that A14: q = qq and A15: ( dom ( x -tree q ) ) = ( tree ( doms qq ) ) by TREES_4:def 4;
A16: ( len ( doms pp ) ) = ( len p ) by A5,TREES_3:38
.= ( len ( doms qq ) ) by A8,A14,TREES_3:38;
A17: ( dom p ) = ( Seg ( len p ) ) by FINSEQ_1:def 3;
A18:now
let i being (Element of ( NAT ));
assume that
A19: i in ( dom ( doms pp ) )
and
A20: i <> ( k + 1 );
A21: ( q . i ) = ( IFEQ (i,( k + 1 ),e2,( p . i )) ) by A9,A10,A17,A7,A19
.= ( p . i ) by A20,FUNCOP_1:def 8;
reconsider pii = ( p . i ) as DecoratedTree by A7,A19,TREES_3:24;
thus ( ( doms pp ) . i ) = ( dom pii ) by A5,A7,A19,FUNCT_6:22
.= ( ( doms qq ) . i ) by A11,A14,A7,A19,A21,FUNCT_6:22;
end;
reconsider dqq = ( doms qq ) as  Tree-yielding FinSequence;
take q;
<* j *> = <* k *> by A4,FINSEQ_1:88;
then A22: j = ( <* k *> . 1 ) by FINSEQ_1:def 8
.= k by FINSEQ_1:def 8;
then (1 <= ( k + 1 ) & ( k + 1 ) <= ( len p )) by A3,NAT_1:11,NAT_1:13;
then A23: ( k + 1 ) in ( dom p ) by FINSEQ_3:25;
then ( k + 1 ) in ( Seg ( len p ) ) by FINSEQ_1:def 3;
then A24: ( q . ( k + 1 ) ) = ( IFEQ (( k + 1 ),( k + 1 ),e2,( p . ( k + 1 ) )) ) by A9,A10
.= e2 by FUNCOP_1:def 8;
then ( ( doms qq ) . ( k + 1 ) ) = ( dom e2 ) by A11,A23,A14,FUNCT_6:22;
then A25: ( dom ( x -tree q ) ) = ( ( dom e1 ) with-replacement (o,( dom e2 )) ) by A2,A23,A15,A6,A16,A7,A18,CKB25:1;
(for f being (FinSequence of ( NAT )) holds (f in ( ( dom e1 ) with-replacement (o,( dom e2 )) ) implies (((not o is_a_prefix_of f) & ( ( x -tree q ) . f ) = ( e1 . f )) or (ex r being (FinSequence of ( NAT )) st ((r in ( dom e2 ) & f = ( o ^ r )) & ( ( x -tree q ) . f ) = ( e2 . r ))))))
proof
reconsider o9 = o as (Element of ( dom e1 )) by A1;
let f being (FinSequence of ( NAT ));
assume A26: f in ( ( dom e1 ) with-replacement (o,( dom e2 )) );
per cases  by A26,CKB22:1;
suppose A27: (not o9 is_a_prefix_of f);

A28: ( ( x -tree q ) . f ) = ( e1 . f )
proof
per cases  by A15,A25,A26,TREES_3:def 15;
suppose A29: f = ( {} );

hence ( ( x -tree q ) . f ) = x by TREES_4:def 4
.= ( e1 . f ) by A2,A29,TREES_4:def 4;
end;
suppose (ex w being (Element of ( NAT )) st (ex u being FinSequence st ((w < ( len dqq ) & u in ( dqq . ( w + 1 ) )) & f = ( <* w *> ^ u ))));

then consider w being (Element of ( NAT )),u being FinSequence such that A30: w < ( len ( doms q ) ) and A31: u in ( ( doms q ) . ( w + 1 ) ) and A32: f = ( <* w *> ^ u ) by A14;
reconsider u as (FinSequence of ( NAT )) by A32,FINSEQ_1:36;
reconsider ww = <* w *> as (FinSequence of ( NAT ));
A33: ( w + 1 ) <> ( k + 1 ) by A27,A32,TREES_1:1;
A34: (ex pp being  DTree-yielding FinSequence st (p = pp & ( dom ( x -tree p ) ) = ( tree ( doms pp ) ))) by TREES_4:def 4;
A35: w < ( len q ) by A30,TREES_3:38;
then A36: ( ( x -tree q ) | <* w *> ) = ( q . ( w + 1 ) ) by TREES_4:def 4;
(1 <= ( w + 1 ) & ( w + 1 ) <= ( len p )) by A8,A35,NAT_1:11,NAT_1:13;
then A37: ( w + 1 ) in ( dom p ) by FINSEQ_3:25;
then reconsider pw1 = ( p . ( w + 1 ) ) as DecoratedTree by TREES_3:24;
A38: ( q . ( w + 1 ) ) = ( IFEQ (( w + 1 ),( k + 1 ),e2,( p . ( w + 1 ) )) ) by A9,A10,A17,A37
.= ( p . ( w + 1 ) ) by A33,FUNCOP_1:def 8;
( w + 1 ) in ( dom ( doms p ) ) by A37,TREES_3:37;
then A39: ( ( dom ( x -tree p ) ) | <* w *> ) = ( ( doms p ) . ( w + 1 ) ) by A34,CKB23:1
.= ( dom pw1 ) by A37,FUNCT_6:22
.= ( ( doms q ) . ( w + 1 ) ) by A11,A37,A38,FUNCT_6:22;
( w + 1 ) in ( dom ( doms q ) ) by A11,A37,TREES_3:37;
then ( ( dom ( x -tree q ) ) | <* w *> ) = ( ( doms q ) . ( w + 1 ) ) by A14,A15,CKB23:1;
hence ( ( x -tree q ) . f ) = ( ( ( x -tree q ) | ww ) . u ) by A31,A32,TREES_2:def 10
.= ( ( ( x -tree p ) | ww ) . u ) by A8,A35,A36,A38,TREES_4:def 4
.= ( e1 . f ) by A2,A31,A32,A39,TREES_2:def 10;
end;
end;
assume (o is_a_prefix_of f or ( ( x -tree q ) . f ) <> ( e1 . f ));
hence thesis by A27,A28;
end;
suppose (ex t1 being (Element of ( dom e2 )) st f = ( o9 ^ t1 ));

then consider r being (Element of ( dom e2 )) such that A40: f = ( o ^ r );
assume (o is_a_prefix_of f or ( ( x -tree q ) . f ) <> ( e1 . f ));
A41: ( ( x -tree q ) | o ) = ( q . ( k + 1 ) ) by A8,A3,A22,TREES_4:def 4;
reconsider r as (FinSequence of ( NAT ));
take r;
thus A42: r in ( dom e2 );
thus f = ( o ^ r ) by A40;
r in ( ( dom ( x -tree q ) ) | o ) by A1,A25,A42,TREES_1:33;
hence thesis by A24,A40,A41,TREES_2:def 10;
end;
end;
hence ( e1 with-replacement (o,e2) ) = ( x -tree q ) by A1,A25,TREES_2:def 11;
thus ( len q ) = ( len p ) by A8;
thus ( q . ( k + 1 ) ) = e2 by A24;
let i being (Element of ( NAT ));
assume i in ( dom p );
then ( q . i ) = ( IFEQ (i,( k + 1 ),e2,( p . i )) ) by A9,A10,A17;
hence thesis by FUNCOP_1:def 8;
end;
